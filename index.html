<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABSEN BEGADANG BULAN PUASA üî•</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}
.card{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}
input,button{
  width:100%;
  padding:10px;
  margin:5px 0;
  border:none;
  border-radius:6px;
}
button{
  background:#d4af37;
  font-weight:bold;
  cursor:pointer;
}
img{
  border-radius:50%;
}
h2{color:#d4af37}
</style>
</head>
<body>

<h2>üî• ABSEN BEGADANG RAMADHAN</h2>

<!-- DAFTAR -->
<div class="card">
<h3>Registrasi Anggota</h3>
<input type="text" id="nama" placeholder="Masukkan Nama">
<input type="file" id="foto" accept="image/*">
<button onclick="daftar()">Daftar & Dapatkan QR</button>
<div id="qrcode"></div>
</div>

<!-- LOGIN ADMIN -->
<div class="card">
<h3>Login Admin</h3>
<input type="text" id="adminNama" placeholder="Nama Admin">
<button onclick="loginAdmin()">Login</button>
</div>

<!-- PANEL ADMIN -->
<div class="card" id="adminPanel" style="display:none">
<h3>‚ö° PANEL ADMIN</h3>

<button onclick="toggleScanner()">Scan QR Anggota</button>
<div id="reader" style="margin-top:10px;"></div>

<hr>

<button onclick="resetServer()">Reset Server</button>

<input type="text" id="addAnggota" placeholder="Tambah Anggota Manual">
<button onclick="tambahAnggota()">Tambah Anggota</button>

<input type="text" id="addAdmin" placeholder="Tambah Admin">
<button onclick="tambahAdmin()">Tambah Admin</button>

<input type="text" id="pesanInfo" placeholder="Kirim Info">
<button onclick="kirimInfo()">Kirim Notifikasi</button>

</div>

<!-- LIST -->
<div class="card">
<h3>Daftar Anggota</h3>
<div id="list"></div>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDAeTn9OXkJP5Krlk2J2xtqVqRH6yAdjys",
  authDomain: "tes-mode-55a53.firebaseapp.com",
  databaseURL: "https://tes-mode-55a53-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tes-mode-55a53",
  storageBucket: "tes-mode-55a53.appspot.com",
  messagingSenderId: "187568625202",
  appId: "1:187568625202:web:f7adc75686625a0b8a4e2b"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const anggotaRef = db.ref("anggota_qr");
const adminRef = db.ref("admins_qr");
const infoRef = db.ref("info_qr");

let ADMIN_UTAMA="NIAZI";
let scannerInstance=null;

/* ================= DAFTAR (FIX BUG) ================= */
function daftar(){

  const nama=document.getElementById("nama").value.trim();
  const file=document.getElementById("foto").files[0];

  if(!nama){
    alert("Isi nama!");
    return;
  }

  if(!file){
    alert("Upload foto!");
    return;
  }

  anggotaRef.once("value").then(function(snapshot){

    let data=snapshot.val() || {};
    let sudahAda=false;

    for(let id in data){
      if(data[id].nama.toLowerCase()===nama.toLowerCase()){
        sudahAda=true;
      }
    }

    if(sudahAda){
      alert("Nama sudah terdaftar!");
      return;
    }

    const reader=new FileReader();

    reader.onload=function(e){

      const idQR="QR_"+Date.now();

      anggotaRef.push({
        nama:nama,
        foto:e.target.result,
        qr:idQR,
        hadir:false
      }).then(function(){

        alert("Berhasil daftar!");

        QRCode.toCanvas(idQR,function(err,canvas){
          document.getElementById("qrcode").innerHTML="";
          document.getElementById("qrcode").appendChild(canvas);
        });

        document.getElementById("nama").value="";
        document.getElementById("foto").value="";

      }).catch(function(error){
        alert("Gagal simpan database!");
        console.log(error);
      });
    };

    reader.readAsDataURL(file);

  }).catch(function(err){
    alert("Database error!");
    console.log(err);
  });
}

/* ================= LOGIN ADMIN ================= */
function loginAdmin(){
  const nama=document.getElementById("adminNama").value.trim();

  if(!nama){
    alert("Masukkan nama admin!");
    return;
  }

  adminRef.once("value").then(function(snap){
    let data=snap.val()||{};

    if(nama===ADMIN_UTAMA || data[nama]){
      document.getElementById("adminPanel").style.display="block";
      alert("Login Admin berhasil!");
    }else{
      alert("Bukan admin!");
    }
  });
}

/* ================= SCAN ================= */
function toggleScanner(){

  if(scannerInstance){
    scannerInstance.clear();
    scannerInstance=null;
    document.getElementById("reader").innerHTML="";
    return;
  }

  scannerInstance=new Html5QrcodeScanner("reader",{fps:10,qrbox:250});
  scannerInstance.render(onScanSuccess);
}

function onScanSuccess(decodedText){

  anggotaRef.once("value").then(function(snapshot){
    let data=snapshot.val() || {};

    let ditemukan=false;

    for(let id in data){
      if(data[id].qr===decodedText){

        ditemukan=true;

        anggotaRef.child(id).update({hadir:true});

        alert("Absen berhasil untuk "+data[id].nama);
      }
    }

    if(!ditemukan){
      alert("QR tidak valid!");
    }
  });
}

/* ================= ADMIN FITUR ================= */
function resetServer(){
  if(confirm("Yakin reset semua data?")){
    db.ref().remove();
    alert("Server berhasil direset!");
  }
}

function tambahAnggota(){
  const nama=document.getElementById("addAnggota").value.trim();
  if(!nama) return;

  anggotaRef.push({
    nama:nama,
    foto:"",
    qr:"QR_"+Date.now(),
    hadir:false
  });

  alert("Anggota ditambahkan");
}

function tambahAdmin(){
  const nama=document.getElementById("addAdmin").value.trim();
  if(!nama) return;

  adminRef.child(nama).set(true);
  alert("Admin ditambahkan");
}

function kirimInfo(){
  const pesan=document.getElementById("pesanInfo").value.trim();
  if(!pesan) return;

  infoRef.set({pesan:pesan});
  alert("Notifikasi dikirim!");
}

/* ================= LIST REALTIME (ANTI ERROR) ================= */
anggotaRef.on("value",function(snapshot){

  const data=snapshot.val();
  const list=document.getElementById("list");
  list.innerHTML="";

  if(!data){
    list.innerHTML="Belum ada anggota.";
    return;
  }

  for(let id in data){

    const a=data[id];

    list.innerHTML+=`
      <div style="background:#334155;padding:10px;margin:5px;border-radius:8px">
        ${a.foto ? `<img src="${a.foto}" width="60">` : ""}
        <br><b>${a.nama}</b>
        <br>${a.hadir ? "Hadir ‚úÖ" : "Belum Hadir ‚ùå"}
      </div>
    `;
  }
});

/* ================= NOTIF ================= */
infoRef.on("value",function(snapshot){

  const data=snapshot.val();

  if(data && data.pesan){

    if(Notification.permission==="granted"){
      new Notification("INFO ADMIN",{body:data.pesan});
    }else{
      Notification.requestPermission();
    }
  }
});
</script>

</body>
</html>
